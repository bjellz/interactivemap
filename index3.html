<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <title>Interaktivt kart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { position: absolute; top: 0; left: 0; right: 260px; bottom: 0; }
        #sidebar {
            position: absolute;
            top: 0; right: 0; width: 260px; height: 100%;
            background: #fff;
            box-shadow: -3px 0 8px rgba(0,0,0,0.15);
            padding: 10px;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        #sidebar h3 {
            margin-top: 0;
            font-weight: 700;
            font-size: 1.2rem;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 6px;
            color: #2E7D32;
        }
        .sidebar-section {
            margin-bottom: 20px;
        }
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .filter-buttons button {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .filter-buttons button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .filter-buttons button:hover:not(.active) {
            background-color: #e0e0e0;
        }

        #layerList {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
            flex-grow: 1; /* Allow list to take available space */
        }
        #layerList li {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 10px;
            background: #f9f9f9;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        #layerList li:hover {
            background-color: #e6f4ea;
        }
        #layerList li button {
            background: #d32f2f;
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 8px;
        }
        #layerList li button:hover {
            background: #b71c1c;
        }
        #clearDataBtn {
            display: block;
            width: calc(100% - 20px);
            padding: 10px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: auto; /* Push to bottom */
            margin-bottom: 10px;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        #clearDataBtn:hover {
            background: #F57C00;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .modal-content input[type="text"],
        .modal-content select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }
        .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-content .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }
        .modal-content .modal-buttons #saveEdit {
            background-color: #4CAF50;
            color: white;
        }
        .modal-content .modal-buttons #saveEdit:hover {
            background-color: #45a049;
        }
        .modal-content .modal-buttons #cancelEdit {
            background-color: #f44336;
            color: white;
        }
        .modal-content .modal-buttons #cancelEdit:hover {
            background-color: #da190b;
        }

        /* Search bar styling - Plassert øverst til venstre */
        #searchContainer {
   	position: absolute;
   	top: 10px;
   	right: 280px; /* Justert for å unngå kollisjon med sidebar */
   	left: unset; /* Fjerner venstre-posisjonering hvis den er arvet */
    	z-index: 1000;
   	background: white;
    	padding: 8px;
    	border-radius: 5px;
    	box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    	display: flex;
    	align-items: center;
    	gap: 5px;

        }
        #searchContainer input {
            border: 1px solid #ccc;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 200px; /* Adjust as needed */
        }
        #searchContainer button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }
        #searchContainer button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Søk områder/markører...">
    <button id="searchButton">Søk</button>
</div>


<div id="sidebar">
    <div class="sidebar-section">
        <h3>Områder</h3>
        <div id="areaFilterButtons" class="filter-buttons"></div>
        <ul id="areaList" class="layer-list">
            <li>Ingen områder</li>
        </ul>
    </div>

    <div class="sidebar-section">
        <h3>Markører</h3>
        <div id="markerFilterButtons" class="filter-buttons"></div>
        <ul id="markerList" class="layer-list">
            <li>Ingen markører</li>
        </ul>
    </div>

    <div class="sidebar-section">
        <h3>Vis / Skjul</h3>
        <div class="filter-buttons">
            <button id="toggleAreasBtn" class="active">Vis områder</button>
            <button id="toggleMarkersBtn" class="active">Vis markører</button>
        </div>
    </div>
    <button id="clearDataBtn">Tøm kartdata</button>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Rediger</h3>
        <label for="editName">Navn:</label>
        <input type="text" id="editName"><br>

        <div id="markerOptions">
            <label for="editIcon">Ikon:</label>
            <select id="editIcon"></select><br>
        </div>

        <div id="areaOptions">
            <label for="editAreaType">Områdetype:</label>
            <select id="editAreaType"></select><br>
        </div>

        <div class="modal-buttons">
            <button id="saveEdit">Lagre</button>
            <button id="cancelEdit">Avbryt</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

<script>
    // Fargealternativer for områder
    const colorOptions = {
        'Basketpool': { color: '#4CAF50', fillColor: '#A5D6A7', fillOpacity: 0.6 },
        'Redzone': { color: '#E53935', fillColor: '#EF9A9A', fillOpacity: 0.6 },
        'Wireline lagring': { color: '#1E88E5', fillColor: '#90CAF9', fillOpacity: 0.6 },
        'Coring lagring': { color: '#FB8C00', fillColor: '#FFCC80', fillOpacity: 0.6 },
        'CWI Retur': { color: '#8E24AA', fillColor: '#CE93D8', fillOpacity: 0.6 },
        'FES lagring': { color: '#00897B', fillColor: '#80CBC4', fillOpacity: 0.6 },
        'DS Retur': { color: '#E10087B', fillColor: '#FFCC80', fillOpacity: 0.6 }
    };

    // Gjenstandsikoner for markører
    const markerIcons = {
        'default_marker': L.icon({ // Keep a default for fallback
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]

        }),
        'Fyllestasjon': L.icon({
            iconUrl: 'https://cdn4.iconfinder.com/data/icons/unigrid-flat-buildings/90/008_084_gas_fuel_gasoline_diesel_petroleum_station-64.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        }),
        'Miljøstasjon': L.icon({
            iconUrl: 'https://cdn1.iconfinder.com/data/icons/bokbokstars-121-classic-stock-icons-1/512/Recover-arrow.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        }),
        'Truckpark': L.icon({
            iconUrl: 'https://cdn4.iconfinder.com/data/icons/global-logistics-2/512/53-64.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        }),
        'Industrivern': L.icon({
            iconUrl: 'https://cdn0.iconfinder.com/data/icons/expenses-vs-income/30/__healthcare_medicine_expense_ambulance-64.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        }),
        'Racks': L.icon({
            iconUrl: 'https://cdn4.iconfinder.com/data/icons/technology-devices-1/500/hard-disk-hdd-64.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        }),
        'Palleområde': L.icon({
            iconUrl: 'https://cdn1.iconfinder.com/data/icons/warehouse-icon-set-1/512/Euro-pallet-flat-group-02-64.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        })
    };

    // Hjelpefunksjon for å hente ikon basert på navn
    function getMarkerIcon(name) {
        return markerIcons[name] || markerIcons['default_marker'];
    }

    // For å generere unike IDs
    let shapeIdCounter = 0;

    // Initier satellittkart
    const map = L.map('map').setView([58.9150, 5.6003], 17.5); // Satt til Gjesdal, Norge

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri',
        maxZoom: 19,
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems, edit: true, remove: true }, // 'edit: true' enables drag and edit handles
        draw: {
            polygon: true,
            rectangle: true,
            marker: true,
            polyline: false,
            circle: false,
            circlemarker: false
        }
    });
    map.addControl(drawControl);

    // Variabler for modalen
    const editModal = document.getElementById('editModal');
    const modalTitle = document.getElementById('modalTitle');
    const editNameInput = document.getElementById('editName');
    const markerOptionsDiv = document.getElementById('markerOptions');
    const editIconSelect = document.getElementById('editIcon');
    const areaOptionsDiv = document.getElementById('areaOptions');
    const editAreaTypeSelect = document.getElementById('editAreaType');
    const saveEditBtn = document.getElementById('saveEdit');
    const cancelEditBtn = document.getElementById('cancelEdit');
    const clearDataBtn = document.getElementById('clearDataBtn');

    let currentEditingLayer = null; // Holder referanse til laget som redigeres

    // Nye DOM-elementer for separate lister og filtre
    const areaList = document.getElementById('areaList');
    const markerList = document.getElementById('markerList');
    const areaFilterButtonsDiv = document.getElementById('areaFilterButtons');
    const markerFilterButtonsDiv = document.getElementById('markerFilterButtons');

    // Search bar elements
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    let currentSearchTerm = ''; // New variable to store the current search term

    // Nye globale filtervariabler
    let showAreas = true;
    let showMarkers = true;

    // Hent de nye knappene for global filtrering
    const toggleAreasBtn = document.getElementById('toggleAreasBtn');
    const toggleMarkersBtn = document.getElementById('toggleMarkersBtn');

    let currentAreaFilter = 'Alle';
    let currentMarkerFilter = 'Alle';

    // Fyll ut dropdown-menyer for ikon og område-typer dynamisk
    function populateModalOptions() {
        // Ikoner
        editIconSelect.innerHTML = '';
        // Loop through keys of markerIcons, excluding the 'default_marker' for user selection
        for (const key in markerIcons) {
            if (key === 'default_marker') continue; // Skip default marker in selection
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' '); // Format for display
            editIconSelect.appendChild(option);
        }

        // Område-typer
        editAreaTypeSelect.innerHTML = '';
        for (const key in colorOptions) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key;
            editAreaTypeSelect.appendChild(option);
        }
    }

    // Bygg filterknapper
    function setupFilterButtons() {
        // Area filters
        areaFilterButtonsDiv.innerHTML = '';
        let allAreasBtn = document.createElement('button');
        allAreasBtn.textContent = 'Alle';
        allAreasBtn.classList.add('active'); // Start with 'Alle' active
        allAreasBtn.onclick = () => setAreaFilter('Alle');
        areaFilterButtonsDiv.appendChild(allAreasBtn);

        for (const type in colorOptions) {
            let btn = document.createElement('button');
            btn.textContent = type;
            btn.onclick = () => setAreaFilter(type);
            areaFilterButtonsDiv.appendChild(btn);
        }

        // Marker filters
        markerFilterButtonsDiv.innerHTML = '';
        let allMarkersBtn = document.createElement('button');
        allMarkersBtn.textContent = 'Alle';
        allMarkersBtn.classList.add('active'); // Start with 'Alle' active
        allMarkersBtn.onclick = () => setMarkerFilter('Alle');
        markerFilterButtonsDiv.appendChild(allMarkersBtn);

        // Loop through keys of markerIcons, excluding the 'default_marker' for filter buttons
        for (const type in markerIcons) {
            if (type === 'default_marker') continue; // Skip default marker in filter buttons
            let btn = document.createElement('button');
            btn.textContent = type.charAt(0).toUpperCase() + type.slice(1).replace(/_/g, ' ');
            btn.onclick = () => setMarkerFilter(type);
            markerFilterButtonsDiv.appendChild(btn);
        }
    }

    function setAreaFilter(filter) {
        currentAreaFilter = filter;
        updateSidebar();
        updateFilterButtonActiveState(areaFilterButtonsDiv, filter);
        filterMapLayers();
    }

    function setMarkerFilter(filter) {
        currentMarkerFilter = filter;
        updateSidebar();
        updateFilterButtonActiveState(markerFilterButtonsDiv, filter);
        filterMapLayers();
    }

    function updateFilterButtonActiveState(container, activeFilter) {
        Array.from(container.children).forEach(button => {
            if (button.textContent.toLowerCase().replace(/ /g, '_') === activeFilter.toLowerCase()) { // Adjust for space in display name
                button.classList.add('active');
            } else if (activeFilter === 'Alle' && button.textContent === 'Alle') {
                button.classList.add('active');
            }
            else {
                button.classList.remove('active');
            }
        });
    }

    // Filter map layers based on current selections AND search term
    function filterMapLayers() {
        const searchTermLower = currentSearchTerm.toLowerCase();

        drawnItems.eachLayer(layer => {
            let showLayer = true;
            const name = layer.feature?.properties?.name || '';
            const nameMatchesSearch = searchTermLower === '' || name.toLowerCase().includes(searchTermLower);

            if (layer instanceof L.Marker) {
                // Sjekk global markør-synlighet FØR andre filtre
                if (!showMarkers) {
                    showLayer = false;
                } else {
                    const iconType = layer.feature?.properties?.icon || 'default_marker';
                    if (currentMarkerFilter !== 'Alle' && iconType !== currentMarkerFilter) {
                        showLayer = false;
                    }
                }
            } else { // Area
                // Sjekk global område-synlighet FØR andre filtre
                if (!showAreas) {
                    showLayer = false;
                } else {
                    const areaType = layer.feature?.properties?.area || 'Basketpool';
                    if (currentAreaFilter !== 'Alle' && areaType !== currentAreaFilter) {
                        showLayer = false;
                    }
                }
            }

            // Combine filter and search conditions
            if (showLayer && nameMatchesSearch) {
                if (!map.hasLayer(layer)) {
                    layer.addTo(map);
                }
            } else {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            }
        });
    }


    // Åpne redigeringsmodalen
    function openEditModal(layer) {
        currentEditingLayer = layer;
        const isMarker = layer instanceof L.Marker;

        // Fyll ut modalen basert på lagtype
        if (isMarker) {
            modalTitle.textContent = 'Rediger Markør';
            markerOptionsDiv.style.display = 'block';
            areaOptionsDiv.style.display = 'none';

            editNameInput.value = layer.feature.properties.name || '';
            editIconSelect.value = layer.feature.properties.icon || 'default_marker'; // Set default for markers
        } else {
            modalTitle.textContent = 'Rediger Område';
            markerOptionsDiv.style.display = 'none';
            areaOptionsDiv.style.display = 'block';

            editNameInput.value = layer.feature.properties.name || '';
            editAreaTypeSelect.value = layer.feature.properties.area || 'Basketpool';
        }
        editModal.style.display = 'flex'; // Bruker flex for sentrering
    }

    // Lukk redigeringsmodalen
    function closeEditModal() {
        editModal.style.display = 'none';
        currentEditingLayer = null;
    }

    // Hendelseslytter for "Lagre" i modalen
    saveEditBtn.onclick = () => {
        if (!currentEditingLayer) return;

        const newName = editNameInput.value.trim();
        if (!newName) {
            alert('Navn kan ikke være tomt.');
            return;
        }

        const isMarker = currentEditingLayer instanceof L.Marker;

        if (isMarker) {
            const newIcon = editIconSelect.value;
            currentEditingLayer.feature.properties.name = newName;
            currentEditingLayer.feature.properties.icon = newIcon;
            currentEditingLayer.setIcon(getMarkerIcon(newIcon));
            // Ensure tooltip is unbound for markers
            if (currentEditingLayer._tooltip) {
                currentEditingLayer.unbindTooltip();
            }
            // Add a temporary tooltip on hover for markers
            currentEditingLayer.bindTooltip(newName, { permanent: false, direction: 'top', offset: [0, -20] });
        } else {
            const newAreaType = editAreaTypeSelect.value;
            currentEditingLayer.feature.properties.name = newName;
            currentEditingLayer.feature.properties.area = newAreaType;
            currentEditingLayer.setStyle(colorOptions[newAreaType]);
            currentEditingLayer._tooltip.setContent(newName); // Update tooltip for areas
        }

        updateSidebar();
        saveToLocalStorage();
        closeEditModal();
        filterMapLayers(); // Re-apply filters after update
    };

    // Hendelseslytter for "Avbryt" i modalen
    cancelEditBtn.onclick = () => {
        closeEditModal();
        // If a new layer was just drawn, and then cancelled, remove it from map/drawnItems
        // This logic might need to be refined if you want to undo the drawing itself
        // For now, it just closes the modal.
    };

    // Lagre data til localStorage
    function saveToLocalStorage() {
        const data = drawnItems.toGeoJSON();
        localStorage.setItem('savedMapData', JSON.stringify(data));
    }

    // Last data fra localStorage
    function loadFromLocalStorage() {
        const data = localStorage.getItem('savedMapData');
        if (!data) return;

        const geojson = JSON.parse(data);

        L.geoJSON(geojson, {
            onEachFeature: (feature, layer) => {
                layer.feature = feature; // Ensure feature is properly attached to layer

                if (layer instanceof L.Marker) {
                    const iconName = feature.properties.icon || 'default_marker';
                    layer.setIcon(getMarkerIcon(iconName));
                    layer.options.draggable = true; // Make loaded markers draggable

                    // No permanent tooltip for markers
                    if (layer._tooltip) {
                        layer.unbindTooltip(); // Ensure old permanent tooltips are removed
                    }
                    // Optional: bind a small tooltip that shows on hover, not permanent
                    layer.bindTooltip(feature.properties.name || 'Markør', { permanent: false, direction: 'top', offset: [0, -20] });


                    layer.on('contextmenu', (e) => {
                        L.DomEvent.stopPropagation(e);
                        openEditModal(layer);
                    });

                    // Event listener for when a marker is dragged
                    layer.on('dragend', function(e) {
                        saveToLocalStorage(); // Save new position after drag
                    });

                } else { // Polygon / område
                    const area = feature.properties.area || 'Basketpool';
                    const name = feature.properties.name || area;

                    const style = colorOptions[area] || colorOptions['Basketpool'];
                    layer.setStyle(style);
                    layer.bindTooltip(name, { permanent: true, direction: 'center', offset: [0, 0] }).openTooltip();

                    layer.on('contextmenu', (e) => {
                        L.DomEvent.stopPropagation(e);
                        openEditModal(layer);
                    });
                }
                drawnItems.addLayer(layer);
            }
        });
    }

    // Oppdater sidemeny med lagene og filtrer dem (now also by search term and global visibility)
    function updateSidebar() {
        areaList.innerHTML = '';
        markerList.innerHTML = '';

        let hasAreas = false;
        let hasMarkers = false;
        const searchTermLower = currentSearchTerm.toLowerCase();

        drawnItems.eachLayer(layer => {
            const name = layer.feature?.properties?.name || (layer instanceof L.Marker ? 'Markør' : 'Område');
            const nameMatchesSearch = searchTermLower === '' || name.toLowerCase().includes(searchTermLower);

            let shouldAddToList = false; // Bestem om elementet skal vises i sidebaren

            if (layer instanceof L.Marker) {
                // Hvis markører er globalt skjult, vis dem ikke i sidebaren heller, MEDMINDRE brukeren søker etter det
                if (!showMarkers && searchTermLower === '') {
                    return; // Gå videre til neste lag
                }

                const iconType = layer.feature?.properties?.icon || 'default_marker';
                if ((currentMarkerFilter === 'Alle' || iconType === currentMarkerFilter) && nameMatchesSearch) {
                    shouldAddToList = true;
                    hasMarkers = true;
                }
            } else { // Area (Polygon/Rectangle)
                // Hvis områder er globalt skjult, vis dem ikke i sidebaren heller, MEDMINDRE brukeren søker etter det
                if (!showAreas && searchTermLower === '') {
                    return; // Gå videre til neste lag
                }

                const areaType = layer.feature?.properties?.area || 'Basketpool';
                if ((currentAreaFilter === 'Alle' || areaType === currentAreaFilter) && nameMatchesSearch) {
                    shouldAddToList = true;
                    hasAreas = true;
                }
            }

            if (shouldAddToList) {
                const li = document.createElement('li');
                const nameSpan = document.createElement('span');
                nameSpan.textContent = name;
                nameSpan.style.flexGrow = '1';
                nameSpan.style.userSelect = 'none';

                nameSpan.onclick = () => {
                    if (layer instanceof L.Marker) {
                        map.setView(layer.getLatLng(), 18);
                    } else {
                        map.fitBounds(layer.getBounds());
                    }
                };

                const delBtn = document.createElement('button');
                delBtn.textContent = 'Slett';
                delBtn.title = 'Slett dette laget';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    drawnItems.removeLayer(layer);
                    updateSidebar();
                    saveToLocalStorage();
                    filterMapLayers();
                };

                li.appendChild(nameSpan);
                li.appendChild(delBtn);

                if (layer instanceof L.Marker) {
                    markerList.appendChild(li);
                } else {
                    areaList.appendChild(li);
                }
            }
        });

        // Vis melding hvis ingen områder/markører er synlige
        if (!hasAreas && (currentSearchTerm === '' || !showAreas)) {
            const li = document.createElement('li');
            li.textContent = 'Ingen områder';
            li.style.fontStyle = 'italic';
            areaList.appendChild(li);
        }
        if (!hasMarkers && (currentSearchTerm === '' || !showMarkers)) {
            const li = document.createElement('li');
            li.textContent = 'Ingen markører';
            li.style.fontStyle = 'italic';
            markerList.appendChild(li);
        }
    }

    // Når noe tegnes
    map.on(L.Draw.Event.CREATED, e => {
        const layer = e.layer;
        shapeIdCounter++;

        if (layer instanceof L.Marker) {
            layer.feature = {
                type: "Feature",
                properties: {
                    id: `marker-${shapeIdCounter}`,
                    name: "Ny markør",
                    icon: 'default_marker' // Default til standard gjenstandsikon
                }
            };
            layer.setIcon(getMarkerIcon('default_marker'));
            layer.options.draggable = true; // Make newly drawn markers draggable
            // Ingen permanent tooltip for markører ved opprettelse, kun on-hover
            layer.bindTooltip("Ny markør", { permanent: false, direction: 'top', offset: [0, -20] });


            layer.on('contextmenu', (event) => {
                L.DomEvent.stopPropagation(event);
                openEditModal(layer);
            });

            // Add dragend listener for newly created markers
            layer.on('dragend', function(event) {
                saveToLocalStorage(); // Save new position after drag
            });


        } else { // Polygon / Rectangle
            const defaultArea = 'Basketpool';
            layer.feature = {
                type: "Feature",
                properties: {
                    id: `area-${shapeIdCounter}`,
                    area: defaultArea,
                    name: "Nytt område"
                }
            };

            layer.setStyle(colorOptions[defaultArea]);
            layer.bindTooltip("Nytt område", { permanent: true, direction: 'center', offset: [0, 0] }).openTooltip();

            layer.on('contextmenu', (event) => {
                L.DomEvent.stopPropagation(event);
                openEditModal(layer);
            });

            // Note: Polygons and Rectangles are made draggable through the L.Control.Draw edit: { featureGroup: drawnItems } setting
            // You don't need a specific 'dragend' listener here for them to be saved, as L.Draw handles changes when editing finishes.
        }

        drawnItems.addLayer(layer);
        updateSidebar();
        saveToLocalStorage();
        openEditModal(layer); // Åpne redigeringsmodalen umiddelbart
        filterMapLayers();
    });

    // Når noe slettes via Draw kontroll (eller manuelt via sidebar)
    map.on(L.Draw.Event.DELETED, () => {
        updateSidebar();
        saveToLocalStorage();
        filterMapLayers();
    });

    // Hendelse for når redigering av et lag er ferdig (for polygoner/rektangler)
    map.on(L.Draw.Event.EDITED, () => {
        saveToLocalStorage();
        updateSidebar(); // Sidebar might need update if names change during edit
        filterMapLayers();
    });


    // Tøm all kartdata fra local storage
    clearDataBtn.onclick = () => {
        if (confirm('Er du sikker på at du vil slette all kartdata? Dette kan ikke angres.')) {
            localStorage.clear();
            drawnItems.clearLayers();
            updateSidebar();
            filterMapLayers();
            alert('All kartdata er slettet.');
        }
    };

    // --- Search bar event listeners ---
    searchButton.onclick = () => {
        currentSearchTerm = searchInput.value.trim();
        filterMapLayers();
        updateSidebar(); // Update sidebar to reflect search results
    };

    searchInput.onkeyup = (event) => {
        if (event.key === 'Enter') {
            searchButton.click();
        } else if (searchInput.value.trim() === '' && currentSearchTerm !== '') {
            // If the search bar is cleared, automatically re-apply filters
            currentSearchTerm = '';
            filterMapLayers();
            updateSidebar();
        }
    };

    // --- Global toggle buttons event listeners ---
    toggleAreasBtn.onclick = () => {
        showAreas = !showAreas;
        toggleAreasBtn.classList.toggle('active', showAreas);
        toggleAreasBtn.textContent = showAreas ? 'Vis områder' : 'Skjul områder';
        filterMapLayers();
        updateSidebar();
    };

    toggleMarkersBtn.onclick = () => {
        showMarkers = !showMarkers;
        toggleMarkersBtn.classList.toggle('active', showMarkers);
        toggleMarkersBtn.textContent = showMarkers ? 'Vis markører' : 'Skjul markører';
        filterMapLayers();
        updateSidebar();
    };

    // Initiering
    populateModalOptions();
    setupFilterButtons();
    loadFromLocalStorage();
    updateSidebar();
    filterMapLayers();
</script>

</body>
</html>