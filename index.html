<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="utf-8" />
    <title>Interaktivt kart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; } /* Added overflow: hidden; */

        /* --- Login page styling --- */
        .login-container {
            display: flex; /* Endret til flex for sentrering */
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            background-color: #f4f4f4;
            position: absolute; /* Sørger for at den dekker hele viewport */
            top: 0;
            left: 0;
            z-index: 9999; /* Sørger for at den er over alt annet */
        }

        .login-box {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 25px;
            color: #333;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }

        .input-group input[type="text"],
        .input-group input[type="password"] {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .login-box button[type="submit"] {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 15px;
        }

        .login-box button[type="submit"]:hover {
            background-color: #0056b3;
        }

        .error-message {
            color: red;
            margin-top: 15px;
            font-size: 0.9em;
        }

        /* --- Existing map and sidebar styling --- */
        #map { position: absolute; top: 0; left: 0; right: 260px; bottom: 0; }
        #sidebar {
            position: absolute;
            top: 0; right: 0; width: 260px; height: 100%;
            background: #fff;
            box-shadow: -3px 0 8px rgba(0,0,0,0.15);
            padding: 10px;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        #sidebar h3 {
            margin-top: 0;
            font-weight: 700;
            font-size: 1.2rem;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 6px;
            color: #2E7D32;
        }
        .sidebar-section {
            margin-bottom: 20px;
        }
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .filter-buttons button {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .filter-buttons button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .filter-buttons button:hover:not(.active) {
            background-color: #e0e0e0;
        }

        #layerList {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
            flex-grow: 1; /* Allow list to take available space */
        }
        #layerList li {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 10px;
            background: #f9f9f9;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        #layerList li:hover {
            background-color: #e6f4ea;
        }
        #layerList li button {
            background: #d32f2f;
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 8px;
        }
        #layerList li button:hover {
            background: #b71c1c;
        }
        #clearDataBtn {
            display: block;
            width: calc(100% - 20px);
            padding: 10px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: auto; /* Push to bottom */
            margin-bottom: 10px;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        #clearDataBtn:hover {
            background: #F57C00;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .modal-content input[type="text"],
        .modal-content select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }
        .modal-content .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-content .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }
        .modal-content .modal-buttons #saveEdit {
            background-color: #4CAF50;
            color: white;
        }
        .modal-content .modal-buttons #saveEdit:hover {
            background-color: #45a049;
        }
        .modal-content .modal-buttons #cancelEdit {
            background-color: #f44336;
            color: white;
        }
        .modal-content .modal-buttons #cancelEdit:hover {
            background-color: #da190b;
        }

        /* Search bar styling - Plassert øverst til venstre */
        #searchContainer {
            position: absolute;
            top: 10px;
            right: 280px;
            left: unset;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #searchContainer input {
            border: 1px solid #ccc;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 200px;
        }
        #searchContainer button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }
        #searchContainer button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>Logg inn</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="username">Brukernavn:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="input-group">
                    <label for="password">Passord:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit">Logg inn</button>
                <p id="errorMessage" class="error-message"></p>
            </form>
        </div>
    </div>
    <div id="mapContainer" style="display: none; height: 100%; width: 100%;">
        <div id="map"></div>

        <div id="searchContainer">
            <input type="text" id="searchInput" placeholder="Søk områder/markører...">
            <button id="searchButton">Søk</button>
        </div>

        <div id="sidebar">
            <div class="sidebar-section">
                <h3>Områder</h3>
                <div id="areaFilterButtons" class="filter-buttons"></div>
                <ul id="areaList" class="layer-list">
                    <li>Ingen områder</li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Markører</h3>
                <div id="markerFilterButtons" class="filter-buttons"></div>
                <ul id="markerList" class="layer-list">
                    <li>Ingen markører</li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Vis / Skjul</h3>
                <div class="filter-buttons">
                    <button id="toggleAreasBtn" class="active">Vis områder</button>
                    <button id="toggleMarkersBtn" class="active">Vis markører</button>
                </div>
            </div>
            <button id="clearDataBtn">Tøm kartdata</button>
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <h3 id="modalTitle">Rediger</h3>
                <label for="editName">Navn:</label>
                <input type="text" id="editName"><br>

                <label for="editTags">Tags (kommaseparert):</label>
                <input type="text" id="editTags" placeholder="F.eks. utstyr, vedlikehold, fare"><br>
                <div id="markerOptions">
                    <label for="editIcon">Ikon:</label>
                    <select id="editIcon"></select><br>

                    <label for="markerImageUpload">Last opp bilde (valgfritt):</label>
                    <input type="file" id="markerImageUpload" accept="image/*"><br>
                    <div id="currentMarkerImagePreview" style="margin-top: 10px; text-align: center; display: none;">
                        <p>Gjeldende bilde:</p>
                        <img id="markerImagePreview" src="" alt="Markørbilde forhåndsvisning" style="max-width: 100%; max-height: 150px; border: 1px solid #ddd; border-radius: 4px;">
                        <button id="removeMarkerImage" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 5px;">Fjern bilde</button>
                    </div>
                    <div style="margin-top: 15px;">
                        <input type="checkbox" id="isUnderMaintenanceCheckbox">
                        <label for="isUnderMaintenanceCheckbox" style="display: inline; font-weight: normal;">Vedlikehold pågår</label>
                    </div>
                </div>

                <div id="areaOptions">
                    <label for="editAreaType">Områdetype:</label>
                    <select id="editAreaType"></select><br>
                </div>

                <div class="modal-buttons">
                    <button id="saveEdit">Lagre</button>
                    <button id="cancelEdit">Avbryt</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

    <script>
        // --- START: LOGIN PAGE JAVASCRIPT ---
        const loginPage = document.getElementById('loginPage');
        const mapContainer = document.getElementById('mapContainer');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('errorMessage');

        // Definer gyldig brukernavn og passord
        // ADVARSEL: Dette er usikkert for produksjon. Kun for demonstrasjon.
        const correctUsername = 'bjellz';
        const correctPassword = 'passord123';

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Hindrer at skjemaet sendes på vanlig måte

            const enteredUsername = usernameInput.value;
            const enteredPassword = passwordInput.value;

            if (enteredUsername === correctUsername && enteredPassword === correctPassword) {
                errorMessage.textContent = ''; // Tøm eventuelle feilmeldinger
                loginPage.style.display = 'none'; // Skjul innloggingssiden
                mapContainer.style.display = 'block'; // Vis kartcontaineren
                initializeMapAndData(); // Kall funksjonen som initialiserer kartet
            } else {
                errorMessage.textContent = 'Feil brukernavn eller passord. Prøv igjen.';
            }
        });
        // --- SLUTT: LOGIN PAGE JAVASCRIPT ---

        // Denne funksjonen vil nå initialisere kartet og all kart-relatert logikk
        let map; // Deklarer map globalt, men initialiser den i funksjonen
        let drawnItems; // Deklarer drawnItems globalt
        let drawControl; // Deklarer drawControl globalt

        function initializeMapAndData() {
            // Fargealternativer for områder
            const colorOptions = {
                'Basketpool': { color: '#4CAF50', fillColor: '#A5D6A7', fillOpacity: 0.6 },
                'Redzone': { color: '#E53935', fillColor: '#EF9A9A', fillOpacity: 0.6 },
                'Wireline lagring': { color: '#1E88E5', fillColor: '#90CAF9', fillOpacity: 0.6 },
                'Coring lagring': { color: '#FB8C00', fillColor: '#FFCC80', fillOpacity: 0.6 },
                'CWI Retur': { color: '#8E24AA', fillColor: '#CE93D8', fillOpacity: 0.6 },
                'FES lagring': { color: '#00897B', fillColor: '#80CBC4', fillOpacity: 0.6 },
                'DS Retur': { color: '#E10087B', fillColor: '#FFCC80', fillOpacity: 0.6 } // Merk: Duplikat fargeverdi her, sjekk '#E10087B'
            };

            // Gjenstandsikoner for markører
            const markerIcons = {
                'default_marker': L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                }),
                'Fyllestasjon': L.icon({
                    iconUrl: 'https://cdn4.iconfinder.com/data/icons/unigrid-flat-buildings/90/008_084_gas_fuel_gasoline_diesel_petroleum_station-64.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                }),
                'Miljøstasjon': L.icon({
                    iconUrl: 'https://cdn1.iconfinder.com/data/icons/bokbokstars-121-classic-stock-icons-1/512/Recover-arrow.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                }),
                'Truckpark': L.icon({
                    iconUrl: 'https://cdn4.iconfinder.com/data/icons/global-logistics-2/512/53-64.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                }),
                'Industrivern': L.icon({
                    iconUrl: 'https://cdn0.iconfinder.com/data/icons/expenses-vs-income/30/__healthcare_medicine_expense_ambulance-64.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                }),
                'Racks': L.icon({
                    iconUrl: 'https://cdn4.iconfinder.com/data/icons/technology-devices-1/500/hard-disk-hdd-64.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                }),
                'Palleområde': L.icon({
                    iconUrl: 'https://cdn1.iconfinder.com/data/icons/warehouse-icon-set-1/512/Euro-pallet-flat-group-02-64.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                })
            };

            // Hjelpefunksjon for å hente ikon basert på navn
            function getMarkerIcon(name) {
                return markerIcons[name] || markerIcons['default_marker'];
            }

            // For å generere unike IDs
            let shapeIdCounter = 0;

            // Initialiser kartet FØRST NÅ
            map = L.map('map').setView([58.9150, 5.6003], 17.5); // Satt til Gjesdal, Norge

            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri',
                maxZoom: 19,
            }).addTo(map);

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems, edit: true, remove: true },
                draw: {
                    polygon: true,
                    rectangle: true,
                    marker: true,
                    polyline: false,
                    circle: false,
                    circlemarker: false
                }
            });
            map.addControl(drawControl);

            // Variabler for modalen (hentes nå etter at mapContainer er synlig)
            const editModal = document.getElementById('editModal');
            const modalTitle = document.getElementById('modalTitle');
            const editNameInput = document.getElementById('editName');
            const editTagsInput = document.getElementById('editTags');
            const markerOptionsDiv = document.getElementById('markerOptions');
            const editIconSelect = document.getElementById('editIcon');
            const areaOptionsDiv = document.getElementById('areaOptions');
            const editAreaTypeSelect = document.getElementById('editAreaType');
            const saveEditBtn = document.getElementById('saveEdit');
            const cancelEditBtn = document.getElementById('cancelEdit');
            const clearDataBtn = document.getElementById('clearDataBtn');

            const markerImageUpload = document.getElementById('markerImageUpload');
            const currentMarkerImagePreviewDiv = document.getElementById('currentMarkerImagePreview');
            const markerImagePreview = document.getElementById('markerImagePreview');
            const removeMarkerImageBtn = document.getElementById('removeMarkerImage');

            const isUnderMaintenanceCheckbox = document.getElementById('isUnderMaintenanceCheckbox');

            let currentEditingLayer = null;

            const areaList = document.getElementById('areaList');
            const markerList = document.getElementById('markerList');
            const areaFilterButtonsDiv = document.getElementById('areaFilterButtons');
            const markerFilterButtonsDiv = document.getElementById('markerFilterButtons');

            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            let currentSearchTerm = '';

            let showAreas = true;
            let showMarkers = true;

            const toggleAreasBtn = document.getElementById('toggleAreasBtn');
            const toggleMarkersBtn = document.getElementById('toggleMarkersBtn');

            // ******************************************************
            // START: KODE FOR GLOBALE SYNLIGHETS-TOGGLES
            // ******************************************************

            toggleAreasBtn.onclick = () => {
                showAreas = !showAreas;
                toggleAreasBtn.classList.toggle('active', showAreas);
                filterMapLayers();
                updateSidebar();
            };

            toggleMarkersBtn.onclick = () => {
                showMarkers = !showMarkers;
                toggleMarkersBtn.classList.toggle('active', showMarkers);
                filterMapLayers();
                updateSidebar();
            };

            // ******************************************************
            // SLUTT: KODE FOR GLOBALE SYNLIGHETS-TOGGLES
            // ******************************************************

            let currentAreaFilter = 'Alle';
            let currentMarkerFilter = 'Alle';

            function populateModalOptions() {
                editIconSelect.innerHTML = '';
                for (const key in markerIcons) {
                    if (key === 'default_marker') continue;
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                    editIconSelect.appendChild(option);
                }

                editAreaTypeSelect.innerHTML = '';
                for (const key in colorOptions) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    editAreaTypeSelect.appendChild(option);
                }
            }

            function setupFilterButtons() {
                areaFilterButtonsDiv.innerHTML = '';
                let allAreasBtn = document.createElement('button');
                allAreasBtn.textContent = 'Alle';
                allAreasBtn.classList.add('active');
                allAreasBtn.onclick = () => setAreaFilter('Alle');
                areaFilterButtonsDiv.appendChild(allAreasBtn);

                for (const type in colorOptions) {
                    let btn = document.createElement('button');
                    btn.textContent = type;
                    btn.onclick = () => setAreaFilter(type);
                    areaFilterButtonsDiv.appendChild(btn);
                }

                markerFilterButtonsDiv.innerHTML = '';
                let allMarkersBtn = document.createElement('button');
                allMarkersBtn.textContent = 'Alle';
                allMarkersBtn.classList.add('active');
                allMarkersBtn.onclick = () => setMarkerFilter('Alle');
                markerFilterButtonsDiv.appendChild(allMarkersBtn);

                for (const type in markerIcons) {
                    if (type === 'default_marker') continue;
                    let btn = document.createElement('button');
                    btn.textContent = type.charAt(0).toUpperCase() + type.slice(1).replace(/_/g, ' ');
                    btn.onclick = () => setMarkerFilter(type);
                    markerFilterButtonsDiv.appendChild(btn);
                }
            }

            function setAreaFilter(filter) {
                currentAreaFilter = filter;
                updateSidebar();
                updateFilterButtonActiveState(areaFilterButtonsDiv, filter);
                filterMapLayers();
            }

            function setMarkerFilter(filter) {
                currentMarkerFilter = filter;
                updateSidebar();
                updateFilterButtonActiveState(markerFilterButtonsDiv, filter);
                filterMapLayers();
            }

            function updateFilterButtonActiveState(container, activeFilter) {
                Array.from(container.children).forEach(button => {
                    const buttonValue = button.textContent.toLowerCase().replace(/ /g, '_');
                    if (button.textContent === activeFilter || buttonValue === activeFilter.toLowerCase().replace(/ /g, '_')) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            }

            function shouldLayerBeVisible(layer, searchTermLower) {
                const name = layer.feature?.properties?.name || '';
                const tags = layer.feature?.properties?.tags || [];
                const tagsString = tags.join(' ').toLowerCase();

                const nameMatchesSearch = searchTermLower === '' || name.toLowerCase().includes(searchTermLower);
                const tagsMatchSearch = searchTermLower === '' || tagsString.includes(searchTermLower);
                const searchMatches = nameMatchesSearch || tagsMatchSearch;

                if (layer instanceof L.Marker) {
                    if (!showMarkers && searchTermLower === '') {
                        return false;
                    }
                    const iconType = layer.feature?.properties?.icon || 'default_marker';
                    return (currentMarkerFilter === 'Alle' || iconType === currentMarkerFilter) && searchMatches;
                } else {
                    if (!showAreas && searchTermLower === '') {
                        return false;
                    }
                    const areaType = layer.feature?.properties?.area || 'Basketpool';
                    return (currentAreaFilter === 'Alle' || areaType === currentAreaFilter) && searchMatches;
                }
            }

            function filterMapLayers() {
                const searchTermLower = currentSearchTerm.toLowerCase();

                drawnItems.eachLayer(layer => {
                    if (shouldLayerBeVisible(layer, searchTermLower)) {
                        if (!map.hasLayer(layer)) {
                            layer.addTo(map);
                        }
                        if (layer instanceof L.Marker) {
                            updateMaintenanceCircle(layer);
                        }
                    } else {
                        if (map.hasLayer(layer)) {
                            map.removeLayer(layer);
                        }
                        if (layer instanceof L.Marker && layer._maintenanceCircle) {
                            layer._maintenanceCircle.remove();
                            delete layer._maintenanceCircle;
                        }
                    }
                });
            }

            function updateMaintenanceCircle(marker) {
                if (marker.feature?.properties?.isUnderMaintenance) {
                    if (!marker._maintenanceCircle) {
                        marker._maintenanceCircle = L.circle(marker.getLatLng(), {
                            radius: 15,
                            color: '#E53935',
                            fillColor: '#E53935',
                            fillOpacity: 0.2,
                            weight: 2,
                            dashArray: '5, 5',
                            interactive: false
                        }).addTo(map);
                        marker.on('drag', function() {
                            marker._maintenanceCircle.setLatLng(marker.getLatLng());
                        });
                    } else {
                        marker._maintenanceCircle.setLatLng(marker.getLatLng());
                        if (!map.hasLayer(marker._maintenanceCircle)) {
                            marker._maintenanceCircle.addTo(map);
                        }
                    }
                } else {
                    if (marker._maintenanceCircle) {
                        marker._maintenanceCircle.remove();
                        delete marker._maintenanceCircle;
                    }
                }
            }

            function openEditModal(layer) {
                currentEditingLayer = layer;
                const isMarker = layer instanceof L.Marker;

                markerImageUpload.value = '';
                currentMarkerImagePreviewDiv.style.display = 'none';
                markerImagePreview.src = '';

                editNameInput.value = layer.feature.properties.name || '';
                editTagsInput.value = (layer.feature.properties.tags || []).join(', ');

                if (isMarker) {
                    modalTitle.textContent = 'Rediger Markør';
                    markerOptionsDiv.style.display = 'block';
                    areaOptionsDiv.style.display = 'none';

                    editIconSelect.value = layer.feature.properties.icon || 'default_marker';

                    isUnderMaintenanceCheckbox.checked = !!layer.feature.properties.isUnderMaintenance;

                    if (layer.feature.properties.imageData) {
                        markerImagePreview.src = layer.feature.properties.imageData;
                        currentMarkerImagePreviewDiv.style.display = 'block';
                    }
                } else {
                    modalTitle.textContent = 'Rediger Område';
                    markerOptionsDiv.style.display = 'none';
                    areaOptionsDiv.style.display = 'block';

                    editAreaTypeSelect.value = layer.feature.properties.area || 'Basketpool';
                }
                editModal.style.display = 'flex';
            }

            function closeEditModal() {
                editModal.style.display = 'none';
                currentEditingLayer = null;
                markerImageUpload.value = '';
                currentMarkerImagePreviewDiv.style.display = 'none';
                markerImagePreview.src = '';
                isUnderMaintenanceCheckbox.checked = false;
            }

            markerImageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(readerEvent) {
                        markerImagePreview.src = readerEvent.target.result;
                        currentMarkerImagePreviewDiv.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeMarkerImageBtn.onclick = () => {
                markerImageUpload.value = '';
                markerImagePreview.src = '';
                currentMarkerImagePreviewDiv.style.display = 'none';
                if (currentEditingLayer && currentEditingLayer.feature && currentEditingLayer.feature.properties) {
                    delete currentEditingLayer.feature.properties.imageData;
                }
            };

            saveEditBtn.onclick = () => {
                if (!currentEditingLayer) return;

                const newName = editNameInput.value.trim();
                if (!newName) {
                    alert('Navn kan ikke være tomt.');
                    return;
                }

                const newTagsString = editTagsInput.value.trim();
                const newTags = newTagsString === '' ? [] : newTagsString.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                currentEditingLayer.feature.properties.tags = newTags;

                const isMarker = currentEditingLayer instanceof L.Marker;

                if (isMarker) {
                    const newIcon = editIconSelect.value;
                    currentEditingLayer.feature.properties.name = newName;
                    currentEditingLayer.feature.properties.icon = newIcon;
                    currentEditingLayer.setIcon(getMarkerIcon(newIcon));

                    currentEditingLayer.feature.properties.isUnderMaintenance = isUnderMaintenanceCheckbox.checked;
                    updateMaintenanceCircle(currentEditingLayer);

                    if (markerImagePreview.src && markerImagePreview.src.startsWith('data:image/')) {
                        currentEditingLayer.feature.properties.imageData = markerImagePreview.src;
                    } else {
                        delete currentEditingLayer.feature.properties.imageData;
                    }

                    let popupContent = `<b>${newName}</b>`;
                    if (newTags.length > 0) {
                        popupContent += `<br>Tags: ${newTags.join(', ')}`;
                    }
                    if (currentEditingLayer.feature.properties.isUnderMaintenance) {
                        popupContent += `<br><span style="color: red; font-weight: bold;">Vedlikehold pågår</span>`;
                    }
                    if (currentEditingLayer.feature.properties.imageData) {
                        popupContent += `<br><img src="${currentEditingLayer.feature.properties.imageData}" style="max-width:200px; max-height:150px; margin-top: 10px;">`;
                    }
                    if (currentEditingLayer._popup) {
                        currentEditingLayer.getPopup().setContent(popupContent);
                    } else {
                        currentEditingLayer.bindPopup(popupContent);
                    }

                    if (currentEditingLayer._tooltip) {
                        currentEditingLayer.unbindTooltip();
                    }
                    currentEditingLayer.bindTooltip(newName, { permanent: false, direction: 'top', offset: [0, -20] });
                } else {
                    const newAreaType = editAreaTypeSelect.value;
                    currentEditingLayer.feature.properties.name = newName;
                    currentEditingLayer.feature.properties.area = newAreaType;
                    currentEditingLayer.setStyle(colorOptions[newAreaType]);

                    let tooltipContent = newName;
                    if (newTags.length > 0) {
                        tooltipContent += ` (${newTags.join(', ')})`;
                    }
                    currentEditingLayer._tooltip.setContent(tooltipContent);
                }

                updateSidebar();
                saveToLocalStorage();
                closeEditModal();
                filterMapLayers();
            };

            cancelEditBtn.onclick = () => {
                closeEditModal();
            };

            function saveToLocalStorage() {
                const data = drawnItems.toGeoJSON();
                localStorage.setItem('savedMapData', JSON.stringify(data));
            }

            function loadFromLocalStorage() {
                const data = localStorage.getItem('savedMapData');
                if (!data) return;

                const geojson = JSON.parse(data);

                L.geoJSON(geojson, {
                    onEachFeature: (feature, layer) => {
                        layer.feature = feature;
                        if (!feature.properties.tags) {
                            feature.properties.tags = [];
                        }
                        if (typeof feature.properties.isUnderMaintenance === 'undefined') {
                            feature.properties.isUnderMaintenance = false;
                        }

                        if (layer instanceof L.Marker) {
                            const iconName = feature.properties.icon || 'default_marker';
                            layer.setIcon(getMarkerIcon(iconName));
                            layer.options.draggable = true;

                            let popupContent = `<b>${feature.properties.name || 'Markør'}</b>`;
                            if (feature.properties.tags && feature.properties.tags.length > 0) {
                                popupContent += `<br>Tags: ${feature.properties.tags.join(', ')}`;
                            }
                            if (feature.properties.isUnderMaintenance) {
                                popupContent += `<br><span style="color: red; font-weight: bold;">Vedlikehold pågår</span>`;
                            }
                            if (feature.properties.imageData) {
                                popupContent += `<br><img src="${feature.properties.imageData}" style="max-width:200px; max-height:150px; margin-top: 10px;">`;
                            }
                            layer.bindPopup(popupContent);

                            if (layer._tooltip) {
                                layer.unbindTooltip();
                            }
                            layer.bindTooltip(feature.properties.name || 'Markør', { permanent: false, direction: 'top', offset: [0, -20] });

                            layer.on('contextmenu', (e) => {
                                L.DomEvent.stopPropagation(e);
                                openEditModal(layer);
                            });

                            layer.on('dragend', function(e) {
                                if (layer._maintenanceCircle) {
                                    layer._maintenanceCircle.setLatLng(layer.getLatLng());
                                }
                                saveToLocalStorage();
                            });
                            updateMaintenanceCircle(layer);

                        } else {
                            const area = feature.properties.area || 'Basketpool';
                            const name = feature.properties.name || area;

                            const style = colorOptions[area] || colorOptions['Basketpool'];
                            layer.setStyle(style);

                            let tooltipContent = name;
                            if (feature.properties.tags && feature.properties.tags.length > 0) {
                                tooltipContent += ` (${feature.properties.tags.join(', ')})`;
                            }
                            layer.bindTooltip(tooltipContent, { permanent: true, direction: 'center', offset: [0, 0] }).openTooltip();

                            layer.on('contextmenu', (e) => {
                                L.DomEvent.stopPropagation(e);
                                openEditModal(layer);
                            });
                        }
                        drawnItems.addLayer(layer);
                    }
                });
            }

            function updateSidebar() {
                areaList.innerHTML = '';
                markerList.innerHTML = '';

                let hasAreas = false;
                let hasMarkers = false;
                const searchTermLower = currentSearchTerm.toLowerCase();

                drawnItems.eachLayer(layer => {
                    if (shouldLayerBeVisible(layer, searchTermLower)) {
                        const name = layer.feature?.properties?.name || (layer instanceof L.Marker ? 'Markør' : 'Område');
                        const tags = layer.feature?.properties?.tags || [];
                        const tagsSpanText = tags.length > 0 ? ` (${tags.join(', ')})` : '';

                        const li = document.createElement('li');
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = name;
                        if (tagsSpanText) {
                            const tagsSmall = document.createElement('small');
                            tagsSmall.textContent = tagsSpanText;
                            tagsSmall.style.fontStyle = 'italic';
                            tagsSmall.style.marginLeft = '5px';
                            nameSpan.appendChild(tagsSmall);
                        }
                        if (layer instanceof L.Marker && layer.feature?.properties?.isUnderMaintenance) {
                            const maintenanceSpan = document.createElement('span');
                            maintenanceSpan.textContent = ' (Vedlikehold)';
                            maintenanceSpan.style.color = 'red';
                            maintenanceSpan.style.fontWeight = 'bold';
                            maintenanceSpan.style.marginLeft = '5px';
                            nameSpan.appendChild(maintenanceSpan);
                        }

                        nameSpan.style.flexGrow = '1';
                        nameSpan.style.userSelect = 'none';

                        nameSpan.onclick = () => {
                            if (layer instanceof L.Marker) {
                                map.setView(layer.getLatLng(), 18);
                            } else {
                                map.fitBounds(layer.getBounds());
                            }
                        };

                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Slett';
                        delBtn.title = 'Slett dette laget';
                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            drawnItems.removeLayer(layer);
                            if (layer instanceof L.Marker && layer._maintenanceCircle) {
                                layer._maintenanceCircle.remove();
                                delete layer._maintenanceCircle;
                            }
                            updateSidebar();
                            saveToLocalStorage();
                            filterMapLayers();
                        };

                        li.appendChild(nameSpan);
                        li.appendChild(delBtn);

                        if (layer instanceof L.Marker) {
                            markerList.appendChild(li);
                            hasMarkers = true;
                        } else {
                            areaList.appendChild(li);
                            hasAreas = true;
                        }
                    }
                });

                if (!hasAreas) {
                    const li = document.createElement('li');
                    li.textContent = 'Ingen områder';
                    li.style.fontStyle = 'italic';
                    areaList.appendChild(li);
                }
                if (!hasMarkers) {
                    const li = document.createElement('li');
                    li.textContent = 'Ingen markører';
                    li.style.fontStyle = 'italic';
                    markerList.appendChild(li);
                }
            }

            map.on(L.Draw.Event.CREATED, e => {
                const layer = e.layer;
                shapeIdCounter++;

                if (layer instanceof L.Marker) {
                    layer.feature = {
                        type: "Feature",
                        properties: {
                            id: `marker-${shapeIdCounter}`,
                            name: "Ny markør",
                            icon: 'default_marker',
                            imageData: null,
                            tags: [],
                            isUnderMaintenance: false
                        }
                    };
                    layer.setIcon(getMarkerIcon('default_marker'));
                    layer.options.draggable = true;
                    layer.bindTooltip("Ny markør", { permanent: false, direction: 'top', offset: [0, -20] });
                    layer.bindPopup("<b>Ny markør</b>");

                    layer.on('contextmenu', (event) => {
                        L.DomEvent.stopPropagation(event);
                        openEditModal(layer);
                    });

                    layer.on('dragend', function(event) {
                        if (layer._maintenanceCircle) {
                            layer._maintenanceCircle.setLatLng(layer.getLatLng());
                        }
                        saveToLocalStorage();
                    });

                } else {
                    const defaultArea = 'Basketpool';
                    layer.feature = {
                        type: "Feature",
                        properties: {
                            id: `area-${shapeIdCounter}`,
                            area: defaultArea,
                            name: "Nytt område",
                            tags: []
                        }
                    };

                    layer.setStyle(colorOptions[defaultArea]);
                    layer.bindTooltip("Nytt område", { permanent: true, direction: 'center', offset: [0, 0] }).openTooltip();

                    layer.on('contextmenu', (event) => {
                        L.DomEvent.stopPropagation(event);
                        openEditModal(layer);
                    });
                }

                drawnItems.addLayer(layer);
                updateSidebar();
                saveToLocalStorage();
                openEditModal(layer);
                filterMapLayers();
            });

            map.on(L.Draw.Event.DELETED, (e) => {
                e.layers.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer._maintenanceCircle) {
                        layer._maintenanceCircle.remove();
                        delete layer._maintenanceCircle;
                    }
                });
                updateSidebar();
                saveToLocalStorage();
                filterMapLayers();
            });

            map.on(L.Draw.Event.EDITED, () => {
                saveToLocalStorage();
                updateSidebar();
                filterMapLayers();
            });

            clearDataBtn.onclick = () => {
                if (confirm('Er du sikker på at du vil slette all kartdata? Dette kan ikke angres.')) {
                    localStorage.clear();
                    drawnItems.clearLayers();
                    map.eachLayer(layer => {
                        if (layer instanceof L.Circle && layer._isMaintenanceCircle) {
                            layer.remove();
                        }
                    });

                    updateSidebar();
                    filterMapLayers();
                    alert('All kartdata er slettet.');
                }
            };

            let searchTimeout;
            const SEARCH_DEBOUNCE_DELAY = 300;

            searchInput.addEventListener('keyup', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentSearchTerm = searchInput.value.trim();
                    filterMapLayers();
                    updateSidebar();
                }, SEARCH_DEBOUNCE_DELAY);
            });

            searchButton.onclick = () => {
                clearTimeout(searchTimeout);
                currentSearchTerm = searchInput.value.trim();
                filterMapLayers();
                updateSidebar();
            };

            // Initial setup calls for the map are now inside this function,
            // so they only run after successful login.
            populateModalOptions();
            setupFilterButtons();
            loadFromLocalStorage();
            updateSidebar();
            filterMapLayers();

            // Sørg for at kartet justerer seg riktig etter at det blir synlig
            map.invalidateSize();
        }
    </script>
</body>
</html>
